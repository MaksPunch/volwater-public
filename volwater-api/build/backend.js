(()=>{var e={7139:(e,t,r)=>{const{Sequelize:s}=r(9031);e.exports=new s(process.env.DB_NAME,process.env.DB_USER,process.env.DB_PASSWORD,{dialect:"mysql",host:process.env.DB_HOST,port:process.env.DB_PORT,dialectModule:r(7012)})},5237:(e,t,r)=>{const s=r(2127),a=r(7139),n=process.env.PORT||3e3;(async()=>{try{await a.authenticate(),await a.sync(),s.listen(n,(()=>console.log(`Server has been started on port ${n}...`)))}catch(e){console.log("Server Error",e.message),process.exit(1)}})(),e.exports=s},2127:(e,t,r)=>{r(818).config();const s=r(7252),a=r(6928),n=r(6898),o=r(2096),i=r(8577),d=r(4841),u=r(8839),c=s(),l=r(5977),p=r(6376),m=r(8344).default,h=r(7659);c.use(o("dev")),c.use(i({origin:["http://localhost:5173","http://192.168.0.103:5173"],credentials:!0})),c.set("trust proxy",1),c.use(p({limits:{fileSize:5242880},abortOnLimit:!0})),c.use(s.json()),c.use(s.urlencoded({extended:!1,limit:"5mb"})),c.use(n()),c.use(s.static(a.join(__dirname,"public")));const w=new m({client:new h(process.env.REDIS_URL)});c.use(l({name:"volwater-edu-session",store:w,secret:process.env.SECRET_KEY,resave:!1,saveUninitialized:!1,proxy:!1,cookie:{maxAge:2592e6,sameSite:"lax",secure:!1,httpOnly:!0,partitioned:!1}})),c.use("/api",u),c.use(d),e.exports=c},9957:(e,t,r)=>{const{Course:s,Section:a,User:n,Department:o}=r(3413),i=r(8387),d=r(7139),{Op:u,Sequelize:c}=r(9031);e.exports=new class{async getAll(e,t){const{limit:r,name:n,page:o}=e.query,i=await s.findAndCountAll({include:[{model:a,as:"sections",attributes:[],required:!1},{model:a,where:{deleted:!0},as:"deleted_sections",attributes:[],required:!1}],group:["course.id"],attributes:["id","name","deleted",[d.fn("count",d.fn("distinct",d.col("sections.id"))),"sectionsCount"],[d.fn("count",d.fn("distinct",d.col("deleted_sections.id"))),"deletedSectionsCount"]],limit:Number(r)||10,offset:(Number(o)-1)*(Number(r)||10)||0,where:{name:{[u.substring]:`${n||""}`}},subQuery:!1,order:[["id","DESC"]]});return t.json(i)}async getOne(e,t,r){const{id:a}=e.params,n=await s.findOne({where:{id:a}});return n?t.json(n):r(i.badRequest("Курс не найден"))}async getCoursePage(e,t,r){try{const{id:o}=e.params,{id:u}=e.user,l=await s.findOne({where:{id:o},include:[{model:a,as:"all_sections",attributes:[],where:{deleted:!1},required:!0},{model:a,as:"sections",attributes:[],where:{deleted:!1},required:!1,include:{model:n,as:"users",attributes:[],where:{id:u},through:{attributes:[],where:{completed:!0}},required:!0}}],attributes:["id","name",[c.fn("COUNT",c.fn("DISTINCT",d.col("all_sections.id"))),"sections_count"],[c.fn("COUNT",c.fn("DISTINCT",d.col("sections.id"))),"completed_sections_count"]]});return l?t.json(l):r(i.badRequest("Курс не найден"))}catch(e){return r(i.badRequest(e.message))}}async getHomeUserCourses(e,t,r){try{const{id:l}=e.user,p=await s.findAndCountAll({where:{deleted:!1,[u.or]:[{"$user_course.course_user.userId$":l},{"$departments.users.id$":l}]},include:[{model:n,as:"user_course",where:{id:l},attributes:[],through:{attributes:[]},required:!1},{model:o,where:{deleted:!1},through:{attributes:[]},attributes:[],include:{model:n,where:{id:l},attributes:[],through:{attributes:[]},required:!0},required:!1},{model:a,as:"all_sections",attributes:[],where:{deleted:!1},required:!0},{model:a,as:"sections",attributes:[],where:{deleted:!1},required:!1,include:{model:n,as:"users",where:{id:l},attributes:[],through:{attributes:[]},required:!0}}],attributes:["id","name",[c.fn("COUNT",c.fn("DISTINCT",d.col("all_sections.id"))),"sections_count"],[c.fn("COUNT",c.fn("DISTINCT",d.col("sections.id"))),"completed_sections_count"]],order:[["name","ASC"]],distinct:!0,group:["id"]});return p.rows=p.rows.slice(0,6),p?t.json(p):r(i.badRequest("Курсы не найдены"))}catch(e){return r(i.badRequest(e.message))}}async getUserCourses(e,t,r){try{const{id:d}=e.user,{limit:l,page:p,search:m}=e.query,h=await s.findAll({where:{deleted:!1,[u.or]:[{"$user_course.course_user.userId$":d},{"$departments.users.id$":d}]},include:[{model:n,as:"user_course",where:{id:d},attributes:[],through:{attributes:[]},required:!1},{model:o,where:{deleted:!1},through:{attributes:[]},attributes:[],include:{model:n,where:{id:d},attributes:[],through:{attributes:[]},required:!0},required:!1},{model:a,as:"all_sections",attributes:[],where:{deleted:!1},required:!0}],attributes:["id","name",[c.fn("COUNT",c.fn("DISTINCT",c.col("all_sections.id"))),"sections_count"]],order:[["name","ASC"]],distinct:!0,group:["id"],having:{name:{[u.like]:`%${m||""}%`}}}),w=(Number(p)-1)*(Number(l)||10)||0,g=w+Number(l)||10;let y=h.slice(w,g);return h?t.json({courses:y,coursesCount:h.length}):r(i.badRequest("Курсы не найдены"))}catch(e){return r(i.badRequest(e.message))}}async getCourseSections(e,t,r){const{id:n}=e.params,{limit:o}=e.query;if(!await s.findOne({where:{id:n}}))return r(i.badRequest("Курс не найден"));const d=await a.findAll({where:{courseId:n},limit:o||null});return d?t.json(d):r(i.badRequest("Секции не найдены"))}async create(e,t,r){try{const{name:r}=e.body,a=await s.create({name:r});return t.status(201).json(a)}catch(e){return r(i.badRequest(e.message))}}async delete(e,t,r){try{const{id:r}=e.params,a=await s.findOne({where:{id:r}});return a.deleted=!0,a.save(),t.json(a)}catch(e){return r(i.badRequest(e.message))}}async edit(e,t,r){try{const{id:a}=e.params,{name:n,deleted:o}=e.body,d=await s.findOne({where:{id:a}});return d?(d.name=n||d.name,d.deleted=void 0!==o?o:d.deleted,d.save(),t.json(d)):r(i.badRequest("Курс не найден"))}catch(e){return r(i.badRequest(e.message))}}async destroy(e,t,r){try{const{id:r}=e.params,a=await s.destroy({where:{id:r}});return t.json(a)}catch(e){return r(i.badRequest(e.message))}}}},6598:(e,t,r)=>{const s=r(8387),{Department:a,CourseDepartment:n,Course:o,User:i,UserDepartment:d}=r(3413),{Op:u,Sequelize:c}=r(9031),l=r(7139);e.exports=new class{async getAllWithQuery(e,t,r){const{name:n,page:d,limit:c}=e.query,p={include:[{model:o,attributes:[],through:{attributes:[]}},{model:i,attributes:[],through:{attributes:[]}}],group:["department.id"],attributes:["id","name","deleted",[l.fn("count",l.fn("distinct",l.col("courses.id"))),"coursesCount"],[l.fn("count",l.fn("distinct",l.col("users.id"))),"usersCount"]],where:{name:{[u.substring]:n}},limit:Number(c)||5,offset:(Number(d)-1)*(Number(c)||5),subQuery:!1},m=await a.findAndCountAll(p);return m?t.json(m):r(s.badRequest("Отделы не найдены"))}async getAll(e,t,r){const n=await a.findAll({attributes:["id","name"]});return n?t.json(n):r(s.badRequest("Отделы не найдены"))}async getOne(e,t,r){const{id:n}=e.params,o=await a.findOne({where:{id:n}});return o?t.json(o):r(s.badRequest("Отдел не найден"))}async create(e,t,r){const{name:n}=e.body;if(null==n)return r(s.badRequest("Название отдела не может быть пустым"));const o=await a.create({name:n});return t.status(201).json(o)}async edit(e,t,r){try{const{id:n}=e.params,{name:o,deleted:i}=e.body,d=await a.findOne({where:{id:n}});return d?(d.name=o||d.name,d.deleted=void 0!==i?i:d.deleted,await d.save(),t.json(d)):r(s.badRequest("Отдел не найден"))}catch(e){return r(s.internalError(e.message))}}async delete(e,t,r){try{const{id:n}=e.params,o=await a.findOne({where:{id:n}});return o?(o.deleted=!0,await o.save(),t.json(o)):r(s.badRequest("Отдел не найден"))}catch(e){return r(s.internalError(e.message))}}async destroy(e,t,r){try{const{id:r}=e.params;await a.destroy({where:{id:r}});const s=await a.findOne({order:[["id","ASC"]],limit:1,where:{id:{[u.ne]:r}}});return t.json(s)}catch(e){return r(s.internalError(e.message))}}async addCourse(e,t,r){const{id:i}=e.params,{courseId:d}=e.body;return await a.findOne({where:{id:i}})?await o.findOne({where:{id:d}})?await n.findOne({where:{courseId:d,departmentId:i}})?r(s.badRequest("Курс уже в отделе")):(await n.create({courseId:d,departmentId:i}),t.status(201).json("Успешно добавлено")):r(s.badRequest("Курс не найден")):r(s.badRequest("Отдел не найден"))}async addUser(e,t,r){const{id:n}=e.params,{userId:o}=e.body;return await a.findOne({where:{id:n}})?await i.findOne({where:{id:o}})?await d.findOne({where:{userId:o,departmentId:n}})?r(s.badRequest("Пользователь уже в отделе")):(await d.create({userId:o,departmentId:n}),t.status(201).json("Успешно добавлено")):r(s.badRequest("Пользователь не найден")):r(s.badRequest("Отдел не найден"))}async getCourses(e,t,r){const{id:n}=e.params;if(!await a.findOne({where:{id:n}}))return r(s.badRequest("Отдел не найден"));const i=await o.findAndCountAll({include:[{model:a,where:{id:n}}],attributes:["id","name"],limit:6});return t.json(i)}async getAllDepartmentCourses(e,t,r){try{const{id:r}=e.params,{limit:s,page:n}=e.query,i=await o.findAndCountAll({include:[{model:a,attributes:[],where:{id:r},through:{attributes:[]}}],attributes:["id","name"],limit:Number(s)||10,offset:(Number(s)??10)*(Number(n)-1)||0});return t.json(i)}catch(e){return r(s.badRequest(e.message))}}async getCoursesNotInDepartment(e,t,r){try{const{id:r}=e.params,s=await o.findAll({include:[{model:a,where:{id:r},required:!1}],attributes:["id","name"],where:{"$departments.id$":null}});return s.length?t.json(s):t.json([{id:0,name:"Нет курсов, доступных для добавления"}])}catch(e){return r(s.badRequest(e.message))}}async getUsers(e,t,r){try{const{id:n}=e.params;if(!await a.findOne({where:{id:n}}))return r(s.badRequest("Отдел не найден"));const o=await i.findAndCountAll({include:[{model:a,where:{id:n}}],attributes:["id","name","surname","patronymic"],limit:6});if(!o?.rows?.length)return t.json([]);for(const e of o.rows)e.name=e.surname&&e.name?`${e.surname} ${e.name}${e.patronymic?` ${e.patronymic}`:""}`:"";return t.json(o)}catch(e){return r(s.badRequest(e.message))}}async getAllDepartmentUsers(e,t,r){try{const{id:r}=e.params,{limit:s,page:n}=e.query,o=await i.findAndCountAll({include:[{model:a,attributes:[],where:{id:r},through:{attributes:[]}}],attributes:["id","name","surname","patronymic"],limit:Number(s)||10,offset:(Number(s)??10)*(Number(n)-1)||0});if(!o?.rows?.length)return t.json([]);for(const e of o?.rows)e.name=e.surname&&e.name?`${e.surname} ${e.name}${e.patronymic?` ${e.patronymic}`:""}`:"";return t.json(o)}catch(e){return r(s.badRequest(e.message))}}async getUsersNotInDepartment(e,t,r){try{const{id:r}=e.params,s=await i.findAll({include:[{model:a,where:{id:r},required:!1}],attributes:["id","name","surname","patronymic"],where:{"$departments.id$":null}});if(!s.length)return t.json([{id:0,name:"Нет сотрудников, доступных для прикрепления"}]);for(const e of s)e.name=e.surname&&e.name?`${e.surname} ${e.name}${e.patronymic?` ${e.patronymic}`:""}`:"";return t.json(s)}catch(e){return r(s.badRequest(e.message))}}async removeCourse(e,t,r){try{const{id:r}=e.params,{courseId:s}=e.body,a=await n.findOne({where:{courseId:s,departmentId:r}});return a&&await a.destroy(),t.json("Успешно удалено")}catch(e){return r(s.badRequest(e.message))}}async getFirst(e,t,r){try{const e=await a.findOne({order:[["id","ASC"]],limit:1});return t.json(e)}catch(e){return r(s.badRequest(e.message))}}}},6786:(e,t,r)=>{const{Course:s,User:a,Department:n,Section:o}=r(3413),i=r(8387),{Op:d,Sequelize:u}=r(9031);e.exports=new class{async taskList(e,t,r){try{const{id:r}=e.user,{search:i}=e.query,c=await s.findAll({where:{deleted:!1,[d.or]:[{"$user_course.course_user.userId$":r},{"$departments.users.id$":r}]},include:[{model:a,as:"user_course",where:{id:r},attributes:[],through:{attributes:[]},required:!1},{model:n,where:{deleted:!1},through:{attributes:[]},attributes:[],include:{model:a,where:{id:r},attributes:[],through:{attributes:[]},required:!0},required:!1},{model:o,as:"sections",attributes:["id","name"],where:{deleted:!1},required:!1,order:[["name","ASC"]],include:{model:a,attributes:["id"],where:{id:r},through:{attributes:["completed"],where:{completed:!0}},required:!1},limit:3},{model:o,as:"all_sections",attributes:[],where:{deleted:!1},required:!0}],attributes:["id","name",[u.fn("COUNT",u.col("all_sections.id")),"sections_count"]],order:[["name","ASC"]],distinct:!0,group:["id"],having:{[d.or]:[{name:{[d.like]:`%${i||""}%`}},{id:u.literal(`(\n                SELECT DISTINCT courseId\n                FROM sections\n                WHERE courseId = course.id AND name LIKE '%${i||""}%')`)}]}});let l=c?.map((e=>{const t={...e.dataValues};return t.sections.length>=1&&(t.sections=t.sections.filter((e=>!e?.users[0]?.section_progress?.completed))),t}));l=l?.filter((e=>e.sections.length>0));let p=l.length;return l=l.slice(0,4),t.json({courses:l,coursesCount:p})}catch(e){r(i.badRequest(e.message))}}}},4487:(e,t,r)=>{const{SectionProgress:s,TestProgress:a,QuestionProgress:n,AnswerProgress:o,CourseProgress:i,User:d,CourseUser:u,Course:c,SectionStepProgress:l,SectionStep:p,Section:m,Answer:h,Test:w}=r(3413),g=r(8387),y=r(7139),{Op:b}=r(9031);e.exports=new class{async getCoursesProgress(e,t){const{userId:r}=e.body,s=await i.findAll({include:{all:!0},where:{userId:r}});return t.json(s)}async getAllUsersProgress(e,t){const r=await d.findAll({include:[{model:c,as:"user_course",attributes:[],through:{attributes:[]}},{model:c,as:"user_progress_course",attributes:[],through:{attributes:[],where:{completed:!0}}}],group:["user.id","user_course.id","user_progress_course.id"],attributes:["id","name","surname","role",[y.fn("count",y.fn("distinct",y.col("user_course.id"))),"coursesCount"],[y.fn("count",y.fn("distinct",y.col("user_progress_course.id"))),"completedCoursesCount"]]});return t.json(r)}async getSectionsProgress(e,t){const{userId:r}=e.body,a=await s.findAll({include:{all:!0},where:{userId:r}});return t.json(a)}async getTestsProgress(e,t){const r=await a.findAll({include:{all:!0}});return t.json(r)}async getQuestionsProgress(e,t){const r=await n.findAll({include:{all:!0}});return t.json(r)}async updateAnswerProgress(e,t,r){try{const{answerId:s}=e.params,{userAnswer:a,selected:n}=e.body,i=await o.findOne({where:{answerId:s,userId:e.user.id}});return i?(i.answer=a||i.answer,i.selected=n||i.selected,await i.save(),t.json(i)):r(g.badRequest("Ответ не найден"))}catch(e){r(g.badRequest(e.message))}}async markSectionStepCompleted(e,t,r){try{const{sectionStepId:s}=e.params,a=await p.findOne({where:{id:s}});if(!a)return r(g.badRequest("Шаг не найден"));const n=await l.findOne({where:{sectionStepId:s,userId:e.user.id}});return n?(n.completed=!0,await n.save()):await l.create({sectionStepId:s,userId:e.user.id,completed:!0}),t.json(a)}catch(e){r(g.badRequest(e.message))}}async markSectionCompleted(e,t,r){try{const{sectionId:a}=e.params,n=await m.findOne({where:{id:a}});if(!n)return r(g.badRequest("Секция не найдена"));const o=await s.findOne({where:{sectionId:a,userId:e.user.id}});return o?(o.completed=!0,await o.save()):await s.create({sectionId:a,userId:e.user.id,completed:!0}),t.json(n)}catch(e){r(g.badRequest(e.message))}}async selectAnswer(e,t,r){try{const{answerId:s}=e.params,a=await o.findOne({where:{answerId:s,userId:e.user.id}});return a?(a.selected=!0,await a.save(),t.json(a)):r(g.badRequest("Ответ не найден"))}catch(e){r(g.badRequest(e.message))}}async selectMultipleAnswers(e,t,r){try{const{answers:s,questionId:a}=e.body,n=s.map((e=>e.id)),i=await h.findAll({where:{questionId:a},attributes:["id"]});if(!i)return r(g.badRequest("Ответы не найдены"));const d=i.map((e=>e.dataValues.id));if(await o.update({selected:!1},{where:{answerId:{[b.in]:d},userId:e.user.id}}),!await h.findAll({where:{id:{[b.in]:n}}}))return r(g.badRequest("Ответы не найдены"));for(const t of s)await o.findOne({where:{answerId:t.id,userId:e.user.id}})?await o.update({selected:!0,answer:t.answer??""},{where:{answerId:t.id,userId:e.user.id}}):await o.create({answerId:t.id,userId:e.user.id,selected:!0,answer:t.answer??""});return t.status(204).json("ok")}catch(e){r(g.badRequest(e.message))}}async markTestCompleted(e,t,r){try{const{sectionId:n}=e.params,o=(await m.findOne({where:{id:n}})).testId,i=await w.findOne({where:{id:o,deleted:!1}});if(!i)return r(g.badRequest("Тест не найден"));const d=await a.findOne({where:{testId:o,userId:e.user.id}}),u=await s.findOne({where:{sectionId:n,userId:e.user.id}});return u?(u.completed=!0,await u.save()):await s.create({sectionId:n,userId:e.user.id,completed:!0}),d?(i.completed=!0,await i.save()):await a.create({testId:o,userId:e.user.id,completed:!0}),t.status(204).send("ok")}catch(e){r(g.badRequest(e.message))}}}},2517:(e,t,r)=>{const{Section:s,SectionStep:a,Course:n,Test:o,User:i}=r(3413),d=r(8387),{Op:u,Sequelize:c}=r(9031);e.exports=new class{async getAll(e,t){const r=await s.findAll();return t.json(r)}async getCourseSections(e,t,r){try{const{courseId:n}=e.params,{id:u}=e.user,l=await s.findAll({where:{courseId:n,deleted:!1},include:[{model:a,where:{deleted:!1},as:"all_section_steps",attributes:[]},{model:o,as:"test",attributes:["id"],required:!1,include:{model:i,attributes:["id"],where:{id:u},through:{attributes:["completed"],where:{completed:!0}},required:!1}},{model:a,as:"completed_section_steps",where:{deleted:!1},attributes:[],required:!1,include:{model:i,attributes:[],where:{id:u},through:{attributes:[],where:{completed:!0}},required:!0}}],attributes:["id","name",[c.fn("COUNT",c.fn("DISTINCT",c.col("all_section_steps.id"))),"section_steps_count"],[c.fn("COUNT",c.fn("DISTINCT",c.col("completed_section_steps.id"))),"completed_section_steps_count"]],group:["id","name"]});if(!l)return r(d.badRequest("Темы не найдены"));const p=l.map((e=>({id:e.dataValues.id,name:e.dataValues.name,section_steps_count:e.dataValues.section_steps_count+(e.dataValues.test?1:0),completed_section_steps_count:e.dataValues?.completed_section_steps_count+(e.dataValues?.test?.users[0]?.test_progress?.completed?1:0)})));return t.json(p)}catch(e){r(d.badRequest(e.message))}}async getOne(e,t){const r=await s.findOne({where:{id:e.params.id}});return t.json(r)}async getOneUser(e,t,r){try{const a=await s.findOne({where:{id:e.params.id,deleted:!1},attributes:["id","name","courseId"]});return a?t.json(a):r(d.badRequest("Тема не найдена"))}catch(e){r(d.badRequest(e.message))}}async create(e,t,r){try{const{name:o,courseId:i}=e.body;if(!await n.findOne({where:{id:i}}))return r(d.badRequest("Курс не найден"));const u=await s.create({name:o,courseId:i}),c=await a.create({content:"",sectionId:u.id});return t.status(201).json({section:u,sectionStep:c})}catch(e){r(d.badRequest(e.message))}}async edit(e,t,r){try{const{name:r,deleted:a}=e.body,n=await s.findOne({where:{id:e.params.id}});return n.name=r||n.name,n.deleted=void 0!==a?a:n.deleted,n.save(),t.json(n)}catch(e){r(d.badRequest(e.message))}}async delete(e,t,r){try{const r=await s.findOne({where:{id:e.params.id}});return r.deleted=!0,r.save(),t.json(r)}catch(e){r(d.badRequest(e.message))}}async destroy(e,t,r){try{const r=await s.findOne({where:{id:e.params.id}});return await s.destroy({where:{id:e.params.id}}),t.json(r)}catch(e){r(d.badRequest(e.message))}}async getSectionStepBySectionId(e,t,r){try{const{sectionId:s}=e.params,{step:n}=e.query,o=await a.findOne({where:{sectionId:s,page_number:n}}),i=await a.count({where:{sectionId:s}});return o?t.json({sectionStep:o,sectionStepsCount:i}):r(d.badRequest("Шаг не найден"))}catch(e){r(d.badRequest(e.message))}}async addSectionStep(e,t,r){try{const{sectionId:s}=e.params,{content:n}=e.body;if(void 0===n)return r(d.badRequest("Текст шага не может быть пустым"));if(!s)return r(d.badRequest("id темы не может быть пустым"));const o=await a.findOne({where:{sectionId:s},order:[["page_number","DESC"]]}),i=await a.create({content:n,sectionId:s,page_number:(o?.page_number??0)+1});return t.status(201).json(i)}catch(e){r(d.badRequest(e.message))}}async editSectionStep(e,t,r){try{const{content:r,deleted:s,page_number:n}=e.body,{id:o}=e.params,i=await a.findOne({where:{id:o}});if(i.content=r??i.content,i.deleted=s??i.deleted,n){const e=n>i.page_number?[i.page_number,n]:[n,i.page_number];await a.increment({page_number:n>i.page_number?-1:1},{where:{sectionId:i.sectionId,page_number:{[u.not]:i.page_number,[u.between]:e}},order:[["page_number","ASC"]]});const t=await a.findAll({where:{sectionId:i.sectionId,page_number:{[u.not]:i.page_number,[u.between]:e}},order:[["page_number","ASC"]]});console.log(t)}return i.page_number=n||i.page_number,i.save(),t.json(i)}catch(e){r(d.badRequest(e.message))}}async deleteSectionStep(e,t,r){try{const{id:r}=e.params,s=await a.findOne({where:{id:r}});return s.deleted=!0,s.save(),t.json(s)}catch(e){r(d.badRequest(e.message))}}async destroySectionStep(e,t,r){try{const{id:s}=e.params,n=await a.findOne({where:{id:s}});return(await a.findAll({where:{sectionId:n.sectionId},order:[["page_number","ASC"]]})).length<=1?r(d.badRequest("Нельзя удалить последний шаг")):(await a.increment({page_number:-1},{where:{page_number:{[u.gt]:n.page_number}}}),await a.destroy({where:{id:s}}),t.json(n))}catch(e){r(d.badRequest(e.message))}}async attachTestToSection(e,t,r){try{const{sectionId:a}=e.params,{testId:n}=e.body,i=await s.findOne({where:{id:a}});if(!i)return r(d.badRequest("Тема не найдена"));const u=await o.findOne({where:{id:n}});return u?(i.testId=u.id,await i.save(),t.json(u)):r(d.badRequest("Тест не найден"))}catch(e){r(d.badRequest(e.message))}}async detachTestFromSection(e,t,r){try{const{sectionId:a}=e.params,n=await s.findOne({where:{id:a}});return n?(n.testId=null,await n.save(),t.json(n)):r(d.badRequest("Тема не найдена"))}catch(e){r(d.badRequest(e.message))}}async getSectionStepBySectionIdUser(e,t,r){try{const{sectionId:n}=e.params,{step:o}=e.query,u=await s.findOne({where:{id:n},attributes:["id","name","courseId"],include:{model:i,attributes:["id"],where:{id:e.user.id},through:{where:{completed:!0},attributes:["completed"],required:!1},required:!1}});if(!u)return r(d.badRequest("Тема не найдена"));u.dataValues.completed=u.dataValues.users[0]?.section_progress?.completed??!1,delete u.dataValues.users;const c=await a.findOne({where:{sectionId:n,page_number:o??1},attributes:["id","content","page_number"]});return c?t.json({sectionStep:c,section:u}):r(d.badRequest("Шаг не найден"))}catch(e){r(d.badRequest(e.message))}}async getSectionNavigation(e,t,r){try{const{sectionId:n}=e.params,u=await s.findOne({where:{id:n}});if(!u)return r(d.badRequest("Тема не найдена"));const c=await a.findAll({where:{sectionId:n,deleted:!1},order:[["page_number","ASC"]],attributes:["id","page_number"],include:[{model:i,attributes:["id"],where:{id:e.user.id},through:{attributes:["completed"],where:{completed:!0}},required:!1}]}),l=await o.findOne({where:{id:u.testId,deleted:!1},include:[{model:i,attributes:["id"],where:{id:e.user.id},through:{attributes:["completed"],where:{completed:!0}},required:!1}],attributes:["id"]});l&&(l.dataValues.test=!0,c.push(l));const p=c.map((e=>{const t=e.dataValues.users?.length>0&&(e.dataValues?.users[0]?.section_step_progress?.completed??e.dataValues?.users[0]?.test_progress?.completed);return{id:e.dataValues.id,page_number:e.dataValues.page_number??(c[c.length-2]?.page_number??0)+1,completed:t,test:e.dataValues.test??!1}})),m=p.reduce(((e,t)=>t?.completed?e+1:e),0),h=p.length;return t.json({sectionStepsNavigation:p,completedSectionStepsCount:m,sectionStepsCount:h})}catch(e){r(d.badRequest(e.message))}}}},6020:(e,t,r)=>{const{Test:s,Question:a,Answer:n,Section:o,User:i,TestProgress:d,SectionProgress:u}=r(3413),c=r(8387),{Op:l,Sequelize:p}=r(9031);e.exports=new class{async getAllTests(e,t){const{name:r,page:n,limit:o}=e.query,i=await s.findAndCountAll({include:{model:a,attributes:[]},attributes:["id","name","deleted",[p.fn("count",p.col("questions.id")),"questions_count"]],where:{name:{[l.substring]:r}},limit:Number(o)||10,offset:(Number(n)-1)*(Number(o)||10),subQuery:!1,group:["test.id"]});t.json(i)}async getOneTest(e,t,r){const{testId:a}=e.params,n=await s.findOne({where:{id:a}});if(!n)return r(c.badRequest("Тест не найден"));t.json(n)}async getAllQuestions(e,t,r){try{const{testId:n}=e.params;if(!await s.findOne({where:{id:n}}))return r(c.badRequest("Тест не найден"));const o=await a.findAll({where:{testId:n}});return t.json(o)}catch(e){r(c.badRequest(e.message))}}async getAllQuestionsUser(e,t,r){try{const{sectionId:d}=e.params,u=await o.findOne({where:{id:d,deleted:!1}});if(!u)return r(c.badRequest("Тема не найдена"));const l=u.testId;if(!await s.findOne({where:{id:l,deleted:!1}}))return r(c.badRequest("Тест не найден"));const p=await a.findAll({where:{testId:l,deleted:!1},include:[{model:n,attributes:["id","name"],where:{deleted:!1},include:{model:i,attributes:["id"],where:{id:e.user.id},through:{attributes:["selected","answer"],where:{selected:!0}},required:!1},required:!0},{model:i,attributes:["id"],where:{id:e.user.id},through:{attributes:["completed"],where:{completed:!0}},required:!1}],attributes:["id","name","type"]});if(!p)return r(c.badRequest("Вопросы не найдены"));const m=p.map((e=>{const t=e.answers.map((t=>{const r={id:t.id,name:t.name,selected:t.users[0]?.answer_progress?.selected??!1};return"text"===e.type&&(r.answer=t?.users[0]?.answer_progress?.answer??"",delete r.name),r}));return{id:e.id,name:e.name,type:e.type,completed:e.users[0]?.question_progress?.completed??!1,answers:t}}));return t.json(m)}catch(e){r(c.badRequest(e.message))}}async getAllAnswers(e,t,r){try{const{questionId:s}=e.params;if(!await a.findOne({where:{id:s}}))return r(c.badRequest("Вопрос не найден"));const o=await n.findAll({where:{questionId:s,deleted:!1}});return t.json(o)}catch(e){r(c.badRequest(e.message))}}async createTest(e,t,r){try{const{name:a,sectionId:n}=e.body;if(null==a)return r(c.badRequest("Не указано название теста"));if(!n){const e=await s.create({name:a});return t.status(201).json(e)}const i=await o.findOne({where:{id:n}});if(!i)return r(c.badRequest("Тема не найден"));const d=await s.create({name:a,sectionId:n});return i.testId=d.id,await i.save(),t.status(201).json(d)}catch(e){r(c.badRequest(e.message))}}async addQuestion(e,t,r){try{const{testId:n}=e.params,{name:o,type:i}=e.body,d=await s.findOne({where:{id:n}});if(!d)return r(c.badRequest("Тест не найден"));if(void 0===o)return r(c.badRequest("Не указан вопрос"));if(void 0===i)return r(c.badRequest("Не указан тип вопроса"));const u=await a.create({name:o,type:i,testId:d.id});return t.status(201).json(u)}catch(e){r(c.badRequest(e.message))}}async addAnswer(e,t,r){try{const{questionId:s}=e.params,{name:o,rightAnswer:i}=e.body;if(void 0===o)return r(c.badRequest("Не указан ответ"));const d=await a.findOne({where:{id:s}});if(void 0===d)return r(c.badRequest("Вопрос не найден"));const u=await n.create({name:o,questionId:d.id,right_answer:i});return t.status(201).json(u)}catch(e){r(c.badRequest(e.message))}}async editTest(e,t,r){try{const{testId:a}=e.params,{name:n,deleted:o,sectionId:i}=e.body,d=await s.findOne({where:{id:a}});return d?(d.name=n||d.name,d.deleted=void 0!==o?o:d.deleted,d.sectionId=i??d.sectionId,await d.save(),t.json(d)):r(c.badRequest("Тест не найден"))}catch(e){r(c.badRequest(e.message))}}async editQuestion(e,t,r){try{const{questionId:s}=e.params,{name:o,type:i,deleted:d}=e.body,u=await a.findOne({where:{id:s}});if(!u)return r(c.badRequest("Вопрос не найден"));if(u.name=o||u.name,u.deleted=void 0!==d?d:u.deleted,"text"===i){const e=await n.findOne({where:{questionId:u.id,deleted:!0}});await n.update({deleted:!0},{where:{questionId:u.id,deleted:!1}}),e?await e.update({deleted:!1,right_answer:!0}):await n.create({deleted:!1,name:"",questionId:u.id,right_answer:!0})}else if(("radio"===i||"checkbox"===i)&&"text"===u.type){const e=await n.findOne({where:{questionId:u.id,deleted:!1}});await n.update({deleted:!1},{where:{questionId:u.id,deleted:!0}}),e.deleted=!0,await e.save()}return"radio"===i&&(await n.update({right_answer:!1},{where:{questionId:u.id,right_answer:!0}}),await n.update({right_answer:!0},{where:{questionId:u.id},limit:1,order:[["id","DESC"]]})),void 0!==i&&(await n.findOne({where:{questionId:u.id,right_answer:!0,deleted:!1}})||await n.update({right_answer:!0},{where:{questionId:u.id,deleted:!1},limit:1,order:[["id","DESC"]]})),u.type=i||u.type,await u.save(),t.json(u)}catch(e){r(c.badRequest(e.message))}}async editAnswer(e,t,r){try{const{answerId:s}=e.params,{name:o,deleted:i,right_answer:d}=e.body,u=await n.findOne({where:{id:s}});if(!u)return r(c.badRequest("Ответ не найден"));if(u.name=o||u.name,u.deleted=i??u.deleted,void 0!==d){if("checkbox"===(await a.findOne({where:{id:u.questionId}})).type)return u.right_answer=d??u.right_answer,await u.save(),t.json(u);await n.update({right_answer:!1},{where:{questionId:u.questionId,right_answer:!0}}),await n.update({right_answer:d},{where:{id:s}})}return await u.save(),t.json(u)}catch(e){r(c.badRequest(e.message))}}async deleteTest(e,t,r){try{const{testId:a}=e.params,n=await s.findOne({where:{id:a}});return n?(n.deleted=!0,await n.save(),t.json(n)):r(c.badRequest("Тест не найден"))}catch(e){r(c.badRequest(e.message))}}async deleteQuestion(e,t,r){try{const{questionId:s}=e.params,n=await a.findOne({where:{id:s}});return n?(n.deleted=!0,await n.save(),t.json(n)):r(c.badRequest("Вопрос не найден"))}catch(e){r(c.badRequest(e.message))}}async deleteAnswer(e,t,r){try{const{answerId:s}=e.params,a=await n.findOne({where:{id:s}});return a?(a.deleted=!0,await a.save(),t.json(a)):r(c.badRequest("Ответ не найден"))}catch(e){r(c.badRequest(e.message))}}async destroyTest(e,t,r){try{const{testId:a}=e.params,n=await s.destroy({where:{id:a}});return n?t.json(n):r(c.badRequest("Тест не найден"))}catch(e){r(c.badRequest(e.message))}}async destroyQuestion(e,t,r){try{const{questionId:s}=e.params,n=await a.destroy({where:{id:s}});return n?t.json(n):r(c.badRequest("Вопрос не найден"))}catch(e){r(c.badRequest(e.message))}}async destroyAnswer(e,t,r){try{const{answerId:s}=e.params,a=await n.destroy({where:{id:s}});return a?t.json(a):r(c.badRequest("Ответ не найден"))}catch(e){r(c.badRequest(e.message))}}async getTestsForSection(e,t,r){try{const{sectionId:r}=e.params,a=await s.findAll({attributes:["id","name"]});return t.json(a)}catch(e){r(c.badRequest(e.message))}}async getTestResult(e,t,r){try{const{sectionId:l}=e.params,p=await o.findOne({where:{id:l}});if(!p)return r(c.badRequest("Тема не найдена"));const m=await s.findOne({where:{id:p.testId}});if(!m)return r(c.badRequest("Тест не найден"));const h=await a.findAll({where:{testId:p.testId,deleted:!1},include:[{model:n,attributes:["id","name","right_answer"],where:{deleted:!1},include:{model:i,attributes:["id"],where:{id:e.user.id},through:{attributes:["selected","answer"],where:{selected:!0}},required:!1},required:!0}],attributes:["id","name","type"]}),w=h.reduce(((e,t)=>{if("text"!==t.dataValues.type){const r=t.dataValues.answers,s=new Set,a=new Set;if(r.forEach((e=>{e.right_answer&&s.add(e.id),e?.users[0]?.answer_progress?.selected&&a.add(e.id)})),s.size===a.size&&[...s].every((e=>a.has(e))))return e+1}else if(t.dataValues.answers[0].users[0]?.answer_progress?.answer?.toLowerCase()===t.dataValues?.answers[0]?.name?.toLowerCase()&&t.dataValues?.answers[0]?.right_answer)return e+1;return e}),0),g=await d.findOne({where:{userId:e.user.id,testId:m.id}});g?(g.score=w??0,g.completed=!0,await g.save()):await d.create({userId:e.user.id,testId:m.id,score:w??0,completed:!0});const y=await u.findOne({where:{sectionId:l,userId:e.user.id}});return y?(y.completed=!0,await y.save()):await u.create({sectionId:l,userId:e.user.id,completed:!0}),t.json({questionsCount:h.length,rightQuestionsCount:w})}catch(e){r(c.badRequest(e.message))}}}},1579:(e,t,r)=>{const{User:s,Department:a,Course:n,CourseUser:o,UserDepartment:i}=r(3413),d=r(2021),u=(r(5486),r(8387)),c=r(1572),l=r(829),{Op:p,Sequelize:m}=r(9031),h=r(3903),w=r(6928),g=r(2103),y=r(9896),b=r(7156),f=r(5634);e.exports=new class{async getAll(e,t,r){try{const{page:r,limit:n,name:o,departmentId:i}=e.query,d={include:{model:a,attributes:["id","name"],through:{attributes:[]}},where:{[p.or]:{name:{[p.substring]:`${o||""}`},surname:{[p.substring]:`${o||""}`},patronymic:{[p.substring]:`${o||""}`}}},limit:Number(n)||5,offset:(Number(r)-1)*(Number(n)||5)||0,attributes:["id","name","profile_picture","deleted","surname","patronymic"],group:["id"]};i&&(d.include.where={id:i});const u=await s.findAndCountAll(d);return t.json(u)}catch(e){r(u.internalError(e.message))}}async getOne(e,t,r){try{const{id:a}=e.params,n=e.headers.authorization.split(" ")[1],o=l.verify(n,process.env.ACCESS_TOKEN_PRIVATE_KEY,((e,t)=>e?"err":t));if("err"===o)return t.status(401).json({message:"Не авторизован"});if(o.id!==a&&"ADMIN"!==o.role&&"MODERATOR"!==o.role)return r(u.forbiddenError("Недостаточно прав"));const i=await s.findOne({where:{id:a},attributes:["id","email","name","surname","patronymic","phone","role","deleted","profile_picture"]});return i?t.json(i):r(u.badRequest("Пользователь не найден"))}catch(e){return r(u.internalError(e.message))}}async getProfile(e,t,r){try{const a=e.headers.authorization.split(" ")[1],n=l.verify(a,process.env.ACCESS_TOKEN_PRIVATE_KEY,((e,t)=>e?"err":t));if("err"===n)return t.status(401).json({message:"Не авторизован"});const o=await s.findOne({where:{id:n.id},attributes:["id","email","name","surname","patronymic","phone","profile_picture"]});return o?t.json(o):r(u.badRequest("Пользователь не найден"))}catch(e){return r(u.internalError(e.message))}}async createUser(e,t,r){try{const{email:a,phone:n,password:o,name:i,surname:d,patronymic:c}=e.body;let l=[];if(void 0===a&&l.push("email"),void 0===o&&l.push("пароль"),void 0===i&&l.push("имя"),void 0===d&&l.push("фамилия"),void 0===n&&l.push("номер телефона"),l.length)return r(u.forbiddenError("Следующие поля пусты: "+l.join(", ")));const p=g.AES.encrypt(o,process.env.SECRET_KEY).toString(),m=await s.create({email:a,password:p,name:i,surname:d,patronymic:c,phone:n});return t.status(201).json(m)}catch(e){return r(u.internalError(e))}}async login(e,t,r){try{const{email:a,password:n}=e.body;if(!a)return r(u.forbiddenError("email не заполнен"));const o=await s.findOne({where:{email:a}});if(!o)return r(u.forbiddenError("Пользователь с таким email не существует"));if(!n)return r(u.forbiddenError("Пароль не заполнен"));if(g.AES.decrypt(o.password,process.env.SECRET_KEY).toString(g.enc.Utf8)!==n)return r(u.forbiddenError("Неверный пароль"));const{accessToken:i,refreshToken:c}=d(o);return e.session.refreshToken=c,t.json({accessToken:i,userId:o.id,role:o.role})}catch(e){return r(u.internalError(e.message))}}async updateUser(e,t,r){try{const{id:a,email:n,name:o,surname:i,patronymic:d,phone:c,deleted:m,password:b,default_profile_picture:f}=e.body,I=e.files,R=e.headers.authorization.split(" ")[1],A=l.verify(R,process.env.ACCESS_TOKEN_PRIVATE_KEY,((e,t)=>e?"err":t));if("err"===A)return t.status(401).json({message:"Не авторизован"});if(A.id!==Number(a)&&"ADMIN"!==A.role&&"MODERATOR"!==A.role)return r(u.forbiddenError("Недостаточно прав"));const E=await s.findOne({where:{id:a}});if(!E)return r(u.badRequest("Пользователь не найден"));if(n&&await s.findOne({where:{email:n,id:{[p.ne]:E.id}}}))return r(u.forbiddenError("same email"));if(E.email=n||E.email,E.name=o||E.name,E.surname=i||E.surname,E.patronymic=d??E.patronymic,E.phone=c||E.phone,E.deleted=void 0===m?E.deleted:m,b){if(g.AES.decrypt(E.password,process.env.SECRET_KEY).toString(g.enc.Utf8)===b)return r(u.forbiddenError("same password"));E.password=g.AES.encrypt(b,process.env.SECRET_KEY).toString()}if(f&&E.profile_picture&&"default.png"!==E.profile_picture&&(y.unlink(w.resolve(__dirname,"..","public","userAvatars",E.profile_picture),(e=>{e&&console.log(e)})),E.profile_picture="userAvatars/default.png"),I?.profile_picture){const{profile_picture:e}=I;let t="userAvatars/"+h.v4()+w.extname(e.name);await e.mv(w.resolve(__dirname,"..","public",t)),E.profile_picture&&"userAvatars/default.png"!==E.profile_picture&&y.unlink(w.resolve(__dirname,"..","public",E.profile_picture),(e=>{e&&console.log(e)})),E.profile_picture=t}return await E.save(),E.password="",t.json(E)}catch(e){return r(u.internalError(e.message))}}async updateUserRole(e,t,r){try{const{id:a,role:n}=e.body,o=await s.findOne({where:{id:a}});return o?(o.role=n||o.role,await o.save(),t.json(o)):r(u.badRequest("Пользователь не найден"))}catch(e){return r(u.internalError(e.message))}}async deleteUser(e,t,r){try{const{id:a}=e.params,n=await s.findOne({where:{id:a}});return n?(n.deleted=!0,await n.save(),t.json(n)):r(u.badRequest("Пользователь не найден"))}catch(e){return r(u.internalError(e.message))}}async destroyUser(e,t,r){try{const{id:a}=e.params,n=await s.findOne({where:{id:a}});if(!n)return r(u.badRequest("Пользователь не найден"));await n.destroy();const o=await s.findOne({order:[["id","ASC"]],attributes:["id"]});return t.send(o)}catch(e){return r(u.internalError(e.message))}}async refreshToken(e,t,r){try{const{refreshToken:s}=e.session;if(!s)return e.session.destroy(),r(u.forbiddenError("Пользователь не авторизован"));const a=l.verify(s,process.env.REFRESH_TOKEN_PRIVATE_KEY);if(!a)return e.session.destroy(),r(u.forbiddenError("Данные устарели"));const{accessToken:n}=d(a);return t.json({accessToken:n,userId:a.id,role:a.role})}catch(e){return r(u.internalError(e.message))}}async logout(e,t,r){try{return e.session.destroy(),t.json("Вы вышли из системы")}catch(e){r(u.internalError(e.message))}}async getDepartments(e,t,r){try{const{id:r}=e.params,n=await a.findAndCountAll({where:{deleted:!1},include:{model:s,where:{id:r},through:{attributes:[]},attributes:[]},attributes:["id","name","updatedAt"],order:[["id","ASC"]],limit:6});return t.json(n)}catch(e){return r(u.internalError(e.message))}}async getCourses(e,t,r){try{const{id:r}=e.params,a=await n.findAndCountAll({where:{deleted:!1},include:{model:s,as:"user_course",where:{id:r},through:{attributes:[]},attributes:[]},attributes:["id","name"],order:[["id","ASC"]],limit:6});return t.json(a)}catch(e){return r(u.internalError(e.message))}}async getDepartmentsSelect(e,t,r){try{const{id:r}=e.params,n=await a.findAll({where:{deleted:!1},include:{model:s,where:{id:r},through:{attributes:[]},attributes:[]},attributes:["id"]}),o=await a.findAll({where:{deleted:!1,id:{[p.notIn]:n.map((e=>e.id))}},attributes:["id","name"],order:[["id","ASC"]]});return t.json(o)}catch(e){return r(u.internalError(e.message))}}async getCoursesSelect(e,t,r){try{const{id:r}=e.params,a=await n.findAll({where:{deleted:!1},include:{model:s,as:"user_course",where:{id:r},through:{attributes:[]},attributes:[]},attributes:["id"]}),o=await n.findAll({where:{deleted:!1,id:{[p.notIn]:a.map((e=>e.id))}},order:[["id","ASC"]],attributes:["id","name"]});return t.json(o)}catch(e){return r(u.internalError(e.message))}}async getAllUserCourses(e,t,r){try{const{id:r}=e.params,{limit:a,page:o}=e.query,i=await n.findAndCountAll({include:{model:s,as:"user_course",where:{id:r},through:{attributes:[]},attributes:[]},order:[["id","ASC"]],attributes:["id","name"],limit:Number(a)||10,offset:(Number(a)??10)*(Number(o)-1)||0});return t.json(i)}catch(e){return r(u.internalError(e.message))}}async getAllUserDepartments(e,t,r){try{const{id:r}=e.params,{limit:n,page:o}=e.query,i=await a.findAndCountAll({include:{model:s,where:{id:r},through:{attributes:[]},attributes:[]},order:[["id","ASC"]],attributes:["id","name"],limit:Number(n)||10,offset:(Number(n)??10)*(Number(o)-1)||0});return t.json(i)}catch(e){return r(u.internalError(e.message))}}async attachUserToCourse(e,t,r){try{const{userId:a,courseId:i}=e.params;if(await o.findOne({where:{userId:a,courseId:i}}))return r(u.badRequest("Пользователь уже привязан к курсу"));if(!await n.findOne({where:{id:i}}))return r(u.badRequest("Курс не найден"));if(!await s.findOne({where:{id:a}}))return r(u.badRequest("Пользователь не найден"));const d=await o.create({userId:a,courseId:i});return t.status(201).json(d)}catch(e){return r(u.internalError(e.message))}}async attachUserToDepartment(e,t,r){try{const{userId:n,departmentId:o}=e.params;if(await i.findOne({where:{userId:n,departmentId:o}}))return r(u.badRequest("Пользователь уже привязан к отделу"));if(!await a.findOne({where:{id:o}}))return r(u.badRequest("Отдел не найден"));if(!await s.findOne({where:{id:n}}))return r(u.badRequest("Пользователь не найден"));const d=await i.create({userId:n,departmentId:o});return t.status(201).json(d)}catch(e){return r(u.internalError(e.message))}}async detachUserFromCourse(e,t,r){try{const{userId:s,courseId:a}=e.params,n=await o.findOne({where:{userId:s,courseId:a}});return n?(await n.destroy(),t.sendStatus(204)):r(u.badRequest("Пользователь не привязан к курсу"))}catch(e){return r(u.internalError(e.message))}}async detachUserFromDepartment(e,t,r){const{userId:s,departmentId:a}=e.params,n=await i.findOne({where:{userId:s,departmentId:a}});return n?(await n.destroy(),t.sendStatus(204)):r(u.badRequest("Пользователь не привязан к отделу"))}async sendEmail(e,t,r){try{const{email:a}=e.body,n=await s.findOne({where:{email:a}});if(!n)return r(u.badRequest("Пользователь не найден"));const o=c.createTransport({host:"connect.smtp.bz",port:465,auth:{user:process.env.SMTP_LOGIN,pass:process.env.SMTP_PASSWORD}}),{accessToken:i}=d(n,"1d"),l=encodeURIComponent(i),p=g.AES.decrypt(n.password,process.env.SECRET_KEY).toString(g.enc.Utf8),m=`${process.env.CLIENT_URL}/login?token=${l}`,I=n.email+"_"+h.v4()+".png";y.existsSync(w.resolve(__dirname,"..","public","emailQrCodes"))||y.mkdirSync(w.resolve(__dirname,"..","public","emailQrCodes"),{recursive:!0});const R=w.resolve(__dirname,"..","public","emailQrCodes",I);return await f.toFile(R,m,{width:150,height:150},(e=>{if(e)throw e})),function(e,t){y.readFile(e,{encoding:"utf-8"},(function(e,r){e?t(e):t(null,r)}))}(__dirname+"/../email_templates/invitation.hbs",(function(e,t){if(e)throw new Error("error reading file "+e);const r=b.compile(t)({email:a,link:m,year:(new Date).getFullYear(),password:p,qrCode:I}),s={from:"no-reply@volwater-edu.ru",to:a,subject:"Вход в систему дистанционного обучения ВологдаГорВодоканал",html:r};o.sendMail(s,(function(e){if(e){if(e.message)throw new Error(e.message);throw new Error(e)}}))})),t.json(`Письмо отправлено на ${a}`)}catch(e){return r(u.internalError(e.message))}}async loginWithToken(e,t,r){try{const s=e.headers.authorization.split(" ")[1];if(!s)return r(u.forbiddenError("Пользователь не авторизован"));const a=decodeURIComponent(s),n=l.verify(a,process.env.ACCESS_TOKEN_PRIVATE_KEY);if(!n)return r(u.forbiddenError("Данные устарели"));const{accessToken:o,refreshToken:i}=d(n);return e.session.refreshToken=i,t.json({userId:n.id,role:n.role,accessToken:o})}catch(e){return r(u.internalError(e.message))}}async changePassword(e,t,r){try{const{password:a,oldPassword:n}=e.body,o=e.headers.authorization.split(" ")[1],i=l.verify(o,process.env.ACCESS_TOKEN_PRIVATE_KEY,((e,t)=>e?"err":t));if("err"===i)return t.status(401).json({message:"Не авторизован"});const d=await s.findOne({where:{id:i.id}});return d?g.AES.decrypt(d.password,process.env.SECRET_KEY).toString(g.enc.Utf8)!==n?r(u.forbiddenError("wrong password")):(d.password=g.AES.encrypt(a,process.env.SECRET_KEY).toString(),await d.save(),t.sendStatus(204)):r(u.badRequest("Пользователь не найден"))}catch(e){return r(u.internalError(e.message))}}async getFirst(e,t,r){try{const e=await s.findOne({order:[["id","ASC"]]});return e?t.json(e):r(u.badRequest("Пользователь не найден"))}catch(e){return r(u.internalError(e.message))}}}},3639:(e,t,r)=>{const s=r(8387),a=r(6928),n=r(3903),o=r(9896),{put:i}=r(311);e.exports=new class{async upload(e,t,r){try{const{dir:i}=e.body,d=e.files;if(!d)return r(s.badRequest("Файл не найден"));if(!i)return r(s.badRequest("Папка не указана"));const u=a.resolve(__dirname,"..","public",i);o.existsSync(u)||o.mkdirSync(u,{recursive:!0});const c=n.v4()+a.extname(d.file.name);return await d.file.mv(u+"/"+c),t.json(i+"/"+c)}catch(e){return r(s.internalError(e.message))}}}},8387:e=>{class t extends Error{constructor(e,t){super(),this.status=e,this.message=t}static badRequest(e){return new t(404,e)}static internalError(e){return new t(500,e)}static forbiddenError(e){return new t(400,e)}}e.exports=t},5684:(e,t,r)=>{r(829);const s=r(8506);e.exports=function(e,t,r){if("OPTIONS"===e.method&&r(),void 0===e.headers.authorization)return t.status(401).json({message:"Не авторизован"});try{const a=e.headers.authorization.split(" ")[1];if(!a)return t.status(401).json({message:"Не авторизован"});e.user=s(a,e,t),r()}catch(e){t.status(401).json({message:e.message})}}},4841:(e,t,r)=>{const s=r(8387);e.exports=function(e,t,r,a){return e instanceof s?r.status(e.status).json({message:e.message}):r.status(500).json({message:e.message})}},6754:(e,t,r)=>{r(829);const s=r(8506);e.exports=function(e){return function(t,r,a){if("OPTIONS"===t.method&&a(),void 0===t.headers.authorization)return r.status(401).json({message:"Не авторизован"});try{const n=t.headers.authorization.split(" ")[1];if(!n)return r.status(401).json({message:"Не авторизован"});const o=s(n,t,r);if(o.message&&"jwt expired"===o.message)return r.status(401).json({message:"Не авторизован"});if(!e.includes(o.role))return r.status(403).json({message:"У вас нет доступа"});t.user=o,a()}catch(e){r.status(401).json({message:e.message})}}}},3413:(e,t,r)=>{const s=r(7139),{DataTypes:a}=r(9031),n=s.define("course",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:a.STRING,allowNull:!1},deleted:{type:a.BOOLEAN,defaultValue:!1}}),o=s.define("section",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:a.STRING,allowNull:!1},deleted:{type:a.BOOLEAN,defaultValue:!1}}),i=s.define("section_step",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},content:{type:a.TEXT,allowNull:!1},deleted:{type:a.BOOLEAN,defaultValue:!1},page_number:{type:a.INTEGER,defaultValue:1}}),d=s.define("test",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:a.STRING,allowNull:!1},deleted:{type:a.BOOLEAN,defaultValue:!1}}),u=s.define("question",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:a.STRING,allowNull:!1},deleted:{type:a.BOOLEAN,defaultValue:!1},type:{type:a.ENUM("radio","checkbox","text"),allowNull:!1}}),c=s.define("answer",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:a.STRING,allowNull:!1},deleted:{type:a.BOOLEAN,defaultValue:!1},right_answer:{type:a.BOOLEAN,defaultValue:!1}}),l=s.define("user",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:a.STRING,allowNull:!1},surname:{type:a.STRING,allowNull:!1},patronymic:{type:a.STRING},email:{type:a.STRING,allowNull:!1,unique:!1},phone:{type:a.STRING,allowNull:!1},password:{type:a.STRING,allowNull:!1},role:{type:a.ENUM("ADMIN","USER","MODERATOR"),allowNull:!1,defaultValue:"USER"},deleted:{type:a.BOOLEAN,defaultValue:!1},profile_picture:{type:a.STRING,defaultValue:"userAvatars/default.png"}}),p=s.define("department",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},name:{type:a.STRING,allowNull:!1},deleted:{type:a.BOOLEAN,defaultValue:!1}}),m=s.define("course_progress",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},completed:{type:a.BOOLEAN,defaultValue:!1}}),h=s.define("section_step_progress",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},completed:{type:a.BOOLEAN,defaultValue:!1}}),w=s.define("section_progress",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},completed:{type:a.BOOLEAN,defaultValue:!1}}),g=s.define("test_progress",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},completed:{type:a.BOOLEAN,defaultValue:!1},score:{type:a.INTEGER,defaultValue:0}}),y=s.define("question_progress",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},completed:{type:a.BOOLEAN,defaultValue:!1}}),b=s.define("answer_progress",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0},selected:{type:a.BOOLEAN,defaultValue:!1},answer:{type:a.STRING,defaultValue:""}}),f=s.define("course_department",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0}}),I=s.define("user_department",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0}}),R=s.define("course_user",{id:{type:a.INTEGER,primaryKey:!0,autoIncrement:!0}});n.hasMany(o,{as:"sections"}),n.hasMany(o,{as:"all_sections"}),n.hasMany(o,{as:"deleted_sections"}),o.belongsTo(n),o.hasMany(i,{as:"all_section_steps"}),o.hasMany(i,{as:"completed_section_steps"}),i.belongsTo(o),d.hasMany(o),o.belongsTo(d),d.hasMany(u,{onDelete:"CASCADE"}),u.belongsTo(d),u.hasMany(c,{onDelete:"CASCADE"}),c.belongsTo(u),n.belongsToMany(l,{through:m,as:"user_progress_course"}),l.belongsToMany(n,{through:m,as:"user_progress_course"}),n.belongsToMany(l,{through:R,as:"user_course"}),l.belongsToMany(n,{through:R,as:"user_course"}),i.belongsToMany(l,{through:h}),l.belongsToMany(i,{through:h}),o.belongsToMany(l,{through:w}),l.belongsToMany(o,{through:w}),d.belongsToMany(l,{through:g}),l.belongsToMany(d,{through:g}),u.belongsToMany(l,{through:y}),l.belongsToMany(u,{through:y}),c.belongsToMany(l,{through:b}),l.belongsToMany(c,{through:b}),p.belongsToMany(n,{through:f}),n.belongsToMany(p,{through:f}),p.belongsToMany(l,{through:I}),l.belongsToMany(p,{through:I}),e.exports={Course:n,Section:o,SectionStep:i,Test:d,Question:u,Answer:c,User:l,Department:p,CourseDepartment:f,UserDepartment:I,CourseProgress:m,SectionProgress:w,TestProgress:g,QuestionProgress:y,AnswerProgress:b,CourseUser:R,SectionStepProgress:h}},8756:(e,t,r)=>{const s=r(7252).Router(),a=r(6754),n=r(6020);s.get("/:questionId",n.getAllAnswers),s.post("/:questionId",a(["ADMIN","MODERATOR"]),n.addAnswer),s.put("/:answerId",a(["ADMIN","MODERATOR"]),n.editAnswer),s.delete("/:answerId",a(["ADMIN","MODERATOR"]),n.deleteAnswer),s.delete("/destroy/:answerId",a(["ADMIN","MODERATOR"]),n.destroyAnswer),e.exports=s},1881:(e,t,r)=>{const s=r(7252).Router(),a=r(9957),n=r(6754),o=r(5684);s.get("/",o,a.getAll),s.get("/my_home",o,a.getHomeUserCourses),s.get("/my",o,a.getUserCourses),s.get("/:id",o,a.getOne),s.get("/:id/sections",o,a.getCourseSections),s.get("/:id/page",o,a.getCoursePage),s.post("/",n(["ADMIN","MODERATOR"]),a.create),s.put("/:id",n(["ADMIN","MODERATOR"]),a.edit),s.delete("/:id",n(["ADMIN","MODERATOR"]),a.delete),s.delete("/:id/destroy",n(["ADMIN","MODERATOR"]),a.destroy),e.exports=s},7525:(e,t,r)=>{const s=r(7252).Router(),a=r(6754),n=r(6598);s.get("/",a(["ADMIN","MODERATOR"]),n.getAllWithQuery),s.get("/all",a(["ADMIN","MODERATOR"]),n.getAll),s.get("/first",a(["ADMIN","MODERATOR"]),n.getFirst),s.get("/:id",a(["ADMIN","MODERATOR"]),n.getOne),s.get("/:id/courses",a(["ADMIN","MODERATOR"]),n.getCourses),s.get("/:id/courses_not_in_department",a(["ADMIN","MODERATOR"]),n.getCoursesNotInDepartment),s.get("/:id/all_courses",a(["ADMIN","MODERATOR"]),n.getAllDepartmentCourses),s.get("/:id/users",a(["ADMIN","MODERATOR"]),n.getUsers),s.get("/:id/users_not_in_department",a(["ADMIN","MODERATOR"]),n.getUsersNotInDepartment),s.get("/:id/all_users",a(["ADMIN","MODERATOR"]),n.getAllDepartmentUsers),s.post("/",a(["ADMIN","MODERATOR"]),n.create),s.put("/:id",a(["ADMIN","MODERATOR"]),n.edit),s.delete("/:id",a(["ADMIN","MODERATOR"]),n.delete),s.delete("/destroy/:id",a(["ADMIN","MODERATOR"]),n.destroy),s.post("/:id/add_course",a(["ADMIN","MODERATOR"]),n.addCourse),s.post("/:id/add_user",a(["ADMIN","MODERATOR"]),n.addUser),s.delete("/:id/remove_course",a(["ADMIN","MODERATOR"]),n.removeCourse),e.exports=s},8839:(e,t,r)=>{const s=r(7252),{User:a}=r(3413),n=r(995),o=r(1881),i=r(8460),d=r(103),u=r(6010),c=r(9922),l=r(8756),p=r(7525),m=r(3639),h=s.Router(),w=r(5684),g=r(6786);h.get("/",((e,t)=>{t.send("HI!")})),h.get("/task_list",w,g.taskList),h.post("/upload",m.upload),h.use("/users",n),h.use("/courses",o),h.use("/progress",i),h.use("/sections",d),h.use("/tests",u),h.use("/questions",c),h.use("/answers",l),h.use("/departments",p),e.exports=h},8460:(e,t,r)=>{const s=r(7252).Router(),a=r(5684),n=r(6754),o=r(4487);s.get("/",n(["ADMIN","MODERATOR"]),o.getAllUsersProgress),s.get("/section_progress",n(["ADMIN","MODERATOR"]),o.getSectionsProgress),s.get("/test_progress",n(["ADMIN","MODERATOR"]),o.getTestsProgress),s.get("/question_progress",n(["ADMIN","MODERATOR"]),o.getQuestionsProgress),s.put("/answer_progress/:answerId",n(["ADMIN","MODERATOR"]),o.updateAnswerProgress),s.post("/section_progress/step/:sectionStepId",a,o.markSectionStepCompleted),s.post("/section_progress/:sectionId",a,o.markSectionCompleted),s.post("/answer_progress/multiple_answers",a,o.selectMultipleAnswers),s.post("/answer_progress/:answerId",a,o.selectAnswer),s.post("/test/:sectionId",a,o.markTestCompleted),e.exports=s},9922:(e,t,r)=>{const s=r(7252).Router(),a=r(6754),n=r(5684),o=r(6020);s.get("/user/:sectionId",n,o.getAllQuestionsUser),s.get("/:testId",n,o.getAllQuestions),s.post("/:testId",a(["ADMIN","MODERATOR"]),o.addQuestion),s.put("/:questionId",a(["ADMIN","MODERATOR"]),o.editQuestion),s.delete("/:questionId",a(["ADMIN","MODERATOR"]),o.deleteQuestion),s.delete("/destroy/:questionId",a(["ADMIN","MODERATOR"]),o.destroyQuestion),e.exports=s},103:(e,t,r)=>{const s=r(7252).Router(),a=r(6754),n=r(5684),o=r(2517);s.get("/",n,o.getAll),s.get("/course/:courseId",n,o.getCourseSections),s.get("/:id/user",n,o.getOneUser),s.get("/:id",n,o.getOne),s.post("/",a(["ADMIN","MODERATOR"]),o.create),s.post("/:sectionId/attach_test",a(["ADMIN","MODERATOR"]),o.attachTestToSection),s.put("/:id",a(["ADMIN","MODERATOR"]),o.edit),s.delete("/:id",a(["ADMIN","MODERATOR"]),o.delete),s.delete("/destroy/:id",a(["ADMIN","MODERATOR"]),o.destroy),s.delete("/:sectionId/detach_test",a(["ADMIN","MODERATOR"]),o.detachTestFromSection),s.get("/navigation/:sectionId",n,o.getSectionNavigation),s.get("/step/:sectionId",n,o.getSectionStepBySectionId),s.get("/user/step/:sectionId",n,o.getSectionStepBySectionIdUser),s.post("/step/:sectionId",a(["ADMIN","MODERATOR"]),o.addSectionStep),s.put("/step/:id",a(["ADMIN","MODERATOR"]),o.editSectionStep),s.delete("/step/:id",a(["ADMIN","MODERATOR"]),o.deleteSectionStep),s.delete("/step/destroy/:id",a(["ADMIN","MODERATOR"]),o.destroySectionStep),e.exports=s},6010:(e,t,r)=>{const s=r(7252).Router(),a=r(6754),n=r(5684),o=r(6020);s.get("/",n,o.getAllTests),s.get("/:testId",n,o.getOneTest),s.get("/:sectionId/result",n,o.getTestResult),s.post("/",a(["ADMIN","MODERATOR"]),o.createTest),s.put("/:testId",a(["ADMIN","MODERATOR"]),o.editTest),s.delete("/:testId",a(["ADMIN","MODERATOR"]),o.deleteTest),s.delete("/:testId/destroy",a(["ADMIN","MODERATOR"]),o.destroyTest),s.get("/tests_for_section/:sectionId",a(["ADMIN","MODERATOR"]),o.getTestsForSection),e.exports=s},995:(e,t,r)=>{const s=r(7252).Router(),a=r(1579),n=r(5684),o=r(6754);s.get("/",o(["ADMIN","MODERATOR"]),a.getAll),s.get("/refresh_token",a.refreshToken),s.get("/profile",n,a.getProfile),s.get("/first",o(["ADMIN","MODERATOR"]),a.getFirst),s.get("/:id",n,a.getOne),s.get("/:id/departments",o(["ADMIN","MODERATOR"]),a.getDepartments),s.get("/:id/courses",o(["ADMIN","MODERATOR"]),a.getCourses),s.get("/:id/departments_select",o(["ADMIN","MODERATOR"]),a.getDepartmentsSelect),s.get("/:id/courses_select",o(["ADMIN","MODERATOR"]),a.getCoursesSelect),s.get("/:id/all_courses",o(["ADMIN","MODERATOR"]),a.getAllUserCourses),s.get("/:id/all_departments",o(["ADMIN","MODERATOR"]),a.getAllUserDepartments),s.post("/",o(["ADMIN","MODERATOR"]),a.createUser),s.post("/login",a.login),s.post("/login_with_token",n,a.loginWithToken),s.post("/logout",n,a.logout),s.post("/change_password",n,a.changePassword),s.put("/update_user",n,a.updateUser),s.put("/update_user_role",o(["ADMIN"]),a.updateUserRole),s.delete("/:id",o(["ADMIN","MODERATOR"]),a.deleteUser),s.delete("/destroy/:id",o(["ADMIN","MODERATOR"]),a.destroyUser),s.post("/send_email",o(["ADMIN","MODERATOR"]),a.sendEmail),s.post("/:userId/courses/:courseId",o(["ADMIN","MODERATOR"]),a.attachUserToCourse),s.post("/:userId/departments/:departmentId",o(["ADMIN","MODERATOR"]),a.attachUserToDepartment),s.delete("/:userId/courses/:courseId",o(["ADMIN","MODERATOR"]),a.detachUserFromCourse),s.delete("/:userId/departments/:departmentId",o(["ADMIN","MODERATOR"]),a.detachUserFromDepartment),e.exports=s},2021:(e,t,r)=>{const s=r(829);e.exports=(e,t="15m")=>{try{const r={id:e.id,role:e.role,name:e.name,surname:e.surname,email:e.email};return{accessToken:s.sign(r,process.env.ACCESS_TOKEN_PRIVATE_KEY,{expiresIn:t}),refreshToken:s.sign(r,process.env.REFRESH_TOKEN_PRIVATE_KEY,{expiresIn:"30d"})}}catch(e){return e}}},8506:(e,t,r)=>{const s=r(829);e.exports=(e,t,r)=>{try{return s.verify(e,process.env.ACCESS_TOKEN_PRIVATE_KEY,((e,t)=>{if("TokenExpiredError"===e?.name)throw new Error("jwt expired");if(e)throw new Error(e);return t}))}catch(e){throw new Error(e)}}},9135:e=>{"use strict";e.exports=require("async-retry")},5486:e=>{"use strict";e.exports=require("bcrypt")},5459:e=>{"use strict";e.exports=require("bytes")},8344:e=>{"use strict";e.exports=require("connect-redis")},6898:e=>{"use strict";e.exports=require("cookie-parser")},8577:e=>{"use strict";e.exports=require("cors")},2103:e=>{"use strict";e.exports=require("crypto-js")},818:e=>{"use strict";e.exports=require("dotenv")},7252:e=>{"use strict";e.exports=require("express")},6376:e=>{"use strict";e.exports=require("express-fileupload")},5977:e=>{"use strict";e.exports=require("express-session")},7156:e=>{"use strict";e.exports=require("handlebars")},7659:e=>{"use strict";e.exports=require("ioredis")},1493:e=>{"use strict";e.exports=require("is-buffer")},829:e=>{"use strict";e.exports=require("jsonwebtoken")},2096:e=>{"use strict";e.exports=require("morgan")},7012:e=>{"use strict";e.exports=require("mysql2")},1572:e=>{"use strict";e.exports=require("nodemailer")},5634:e=>{"use strict";e.exports=require("qrcode")},9031:e=>{"use strict";e.exports=require("sequelize")},9956:e=>{"use strict";e.exports=require("undici")},3903:e=>{"use strict";e.exports=require("uuid")},9896:e=>{"use strict";e.exports=require("fs")},6928:e=>{"use strict";e.exports=require("path")},2203:e=>{"use strict";e.exports=require("stream")},9847:(e,t,r)=>{"use strict";function s(e){return e&&e.__esModule?e:{default:e}}function a(e){if(null==e?void 0:e.token)return e.token;if(process.env.BLOB_READ_WRITE_TOKEN)return process.env.BLOB_READ_WRITE_TOKEN;throw new i("No token found. Either configure the `BLOB_READ_WRITE_TOKEN` environment variable, or pass a `token` option to your calls.")}Object.defineProperty(t,"__esModule",{value:!0});var n,o,i=class extends Error{constructor(e){super(`Vercel Blob: ${e}`)}},d=r(9956),u=s(r(9135)),c=!1;try{((null==(n=process.env.DEBUG)?void 0:n.includes("blob"))||(null==(o=process.env.NEXT_PUBLIC_DEBUG)?void 0:o.includes("blob")))&&(c=!0)}catch(e){}function l(e,...t){c&&console.debug(`vercel-blob: ${e}`,...t)}var p=class extends i{constructor(){super("Access denied, please provide a valid token for this resource.")}},m=class extends i{constructor(){super("This store does not exist.")}},h=class extends i{constructor(){super("This store has been suspended.")}},w=class extends i{constructor(){super("Unknown error, please visit https://vercel.com/help.")}},g=class extends i{constructor(){super("The requested blob does not exist")}},y=class extends i{constructor(){super("The blob service is currently not available. Please try again.")}},b=class extends i{constructor(e){super(`Too many requests please lower the number of concurrent requests ${e?` - try again in ${e} seconds`:""}.`),this.retryAfter=null!=e?e:0}},f=class extends i{constructor(){super("The request was aborted.")}},I=7;function R(){try{const e=process.env.VERCEL_BLOB_RETRIES||"10";return parseInt(e,10)}catch(e){return 10}}async function A(e,t,r){const s=function(){let e=null;try{e=process.env.VERCEL_BLOB_API_VERSION_OVERRIDE||process.env.NEXT_PUBLIC_VERCEL_BLOB_API_VERSION_OVERRIDE}catch(e){}return`${null!=e?e:I}`}(),n=a(r),o=function(){const e={};try{"VERCEL_BLOB_PROXY_THROUGH_ALTERNATIVE_API"in process.env?e["x-proxy-through-alternative-api"]=process.env.VERCEL_BLOB_PROXY_THROUGH_ALTERNATIVE_API:"NEXT_PUBLIC_VERCEL_BLOB_PROXY_THROUGH_ALTERNATIVE_API"in process.env&&(e["x-proxy-through-alternative-api"]=process.env.NEXT_PUBLIC_VERCEL_BLOB_PROXY_THROUGH_ALTERNATIVE_API)}catch(e){}return e}(),[,,,c=""]=n.split("_"),A=`${c}:${Date.now()}:${Math.random().toString(16).slice(2)}`;let E=0;const O=await u.default.call(void 0,(async r=>{let a;try{a=await d.fetch.call(void 0,function(e=""){let t=null;try{t=process.env.VERCEL_BLOB_API_URL||process.env.NEXT_PUBLIC_VERCEL_BLOB_API_URL}catch(e){}return`${t||"https://blob.vercel-storage.com"}${e}`}(e),{...t,headers:{"x-api-blob-request-id":A,"x-api-blob-request-attempt":String(E),"x-api-version":s,authorization:`Bearer ${n}`,...o,...t.headers}})}catch(e){if(e instanceof DOMException&&"AbortError"===e.name)return void r(new f);throw e}if(a.ok)return a;const{code:u,error:c}=await async function(e){var t,r,s;let a,n,o;try{const o=await e.json();a=null!=(r=null==(t=o.error)?void 0:t.code)?r:"unknown_error",n=null==(s=o.error)?void 0:s.message}catch(e){a="unknown_error"}switch(a){case"store_suspended":o=new h;break;case"forbidden":o=new p;break;case"not_found":o=new g;break;case"store_not_found":o=new m;break;case"bad_request":o=new i(null!=n?n:"Bad request");break;case"service_unavailable":o=new y;break;case"rate_limited":o=function(e){const t=e.headers.get("retry-after");return new b(t?parseInt(t,10):void 0)}(e);break;default:o=new w}return{code:a,error:o}}(a);if("unknown_error"===u||"service_unavailable"===u||"internal_server_error"===u)throw c;r(c)}),{retries:R(),onRetry:t=>{l(`retrying API request to ${e}`,t.message),E+=1}});if(!O)throw new w;return await O.json()}var E="x-cache-control-max-age",O="x-add-random-suffix",_="x-content-type";function T(e,t){const r={};return e.includes("contentType")&&t.contentType&&(r[_]=t.contentType),e.includes("addRandomSuffix")&&void 0!==t.addRandomSuffix&&(r[O]=t.addRandomSuffix?"1":"0"),e.includes("cacheControlMaxAge")&&void 0!==t.cacheControlMaxAge&&(r[E]=t.cacheControlMaxAge.toString()),r}async function q({pathname:e,options:t,extraChecks:r,getToken:s}){if(!e)throw new i("pathname is required");if(!t)throw new i("missing options, see usage");if("public"!==t.access)throw new i('access must be "public"');return r&&r(t),s&&(t.token=await s(e,t)),t}async function S({uploadId:e,key:t,pathname:r,parts:s,headers:a,options:n}){try{const o=await A(`/mpu/${r}`,{method:"POST",headers:{...a,"content-type":"application/json","x-mpu-action":"complete","x-mpu-upload-id":e,"x-mpu-key":encodeURI(t)},body:JSON.stringify(s),signal:n.abortSignal},n);return l("mpu: complete",o),o}catch(e){throw e instanceof TypeError&&("Failed to fetch"===e.message||"fetch failed"===e.message)?new y:e}}async function N(e,t,r){l("mpu: create","pathname:",e);try{const s=await A(`/mpu/${e}`,{method:"POST",headers:{...t,"x-mpu-action":"create"},signal:r.abortSignal},r);return l("mpu: create",s),s}catch(e){throw e instanceof TypeError&&("Failed to fetch"===e.message||"fetch failed"===e.message)?new y:e}}var v=s(r(5459));async function M({uploadId:e,key:t,pathname:r,headers:s,options:a,internalAbortController:n=new AbortController,part:o}){var i,d,u;const c=A(`/mpu/${r}`,{signal:n.signal,method:"POST",headers:{...s,"x-mpu-action":"upload","x-mpu-key":encodeURI(t),"x-mpu-upload-id":e,"x-mpu-part-number":o.partNumber.toString()},body:o.blob,duplex:"half"},a);function l(){n.abort()}(null==(i=a.abortSignal)?void 0:i.aborted)?l():null==(d=a.abortSignal)||d.addEventListener("abort",l);const p=await c;return null==(u=a.abortSignal)||u.removeEventListener("abort",l),p}var D="undefined"!=typeof window?6:8,C=8388608,x=D*C*2,j=r(2203),U=s(r(1493));async function k(e,t,r,s){l("mpu: init","pathname:",e,"headers:",r);const a=function(e){if(e instanceof ReadableStream)return e;if(e instanceof Blob)return e.stream();if(function(e){return"object"==typeof e&&"function"==typeof e.pipe&&e.readable&&"function"==typeof e._read&&"object"==typeof e._readableState}(e))return j.Readable.toWeb(e);let t;var r,s;return e instanceof ArrayBuffer?t=e:(s=e,U.default.call(void 0,s)?t=e.buffer:(r=e,t=(new TextEncoder).encode(r))),new ReadableStream({start(e){e.enqueue(t),e.close()}})}(t),n=await N(e,r,s),o=await function({uploadId:e,key:t,pathname:r,stream:s,headers:a,options:n}){l("mpu: upload init","key:",t);const o=new AbortController;return new Promise(((i,d)=>{const u=[],c=[],p=s.getReader();let m=0,h=!1,w=1,g=!1,b=0,f=!1,I=0,R=[],A=0;async function E(){for(l("mpu: upload read start","activeUploads:",m,"currentBytesInMemory:",`${v.default.call(void 0,b)}/${v.default.call(void 0,x)}`,"bytesSent:",v.default.call(void 0,I)),h=!0;b<x&&!g;)try{const{value:e,done:t}=await p.read();if(t)return f=!0,l("mpu: upload read consumed the whole stream"),R.length>0&&(u.push({partNumber:w++,blob:new Blob(R,{type:"application/octet-stream"})}),_()),void(h=!1);b+=e.byteLength;let r=0;for(;r<e.byteLength;){const t=C-A,s=Math.min(r+t,e.byteLength),a=e.slice(r,s);R.push(a),A+=a.byteLength,r=s,A===C&&(u.push({partNumber:w++,blob:new Blob(R,{type:"application/octet-stream"})}),R=[],A=0,_())}}catch(e){T(e)}l("mpu: upload read end","activeUploads:",m,"currentBytesInMemory:",`${v.default.call(void 0,b)}/${v.default.call(void 0,x)}`,"bytesSent:",v.default.call(void 0,I)),h=!1}async function O(s){m++,l("mpu: upload send part start","partNumber:",s.partNumber,"size:",s.blob.size,"activeUploads:",m,"currentBytesInMemory:",`${v.default.call(void 0,b)}/${v.default.call(void 0,x)}`,"bytesSent:",v.default.call(void 0,I));try{const d=await M({uploadId:e,key:t,pathname:r,headers:a,options:n,internalAbortController:o,part:s});if(l("mpu: upload send part end","partNumber:",s.partNumber,"activeUploads",m,"currentBytesInMemory:",`${v.default.call(void 0,b)}/${v.default.call(void 0,x)}`,"bytesSent:",v.default.call(void 0,I)),g)return;if(c.push({partNumber:s.partNumber,etag:d.etag}),b-=s.blob.size,m--,I+=s.blob.size,u.length>0&&_(),f)return void(0===m&&(p.releaseLock(),i(c)));h||E().catch(T)}catch(e){T(e)}}function _(){if(!g)for(l("send parts","activeUploads",m,"partsToUpload",u.length);m<D&&u.length>0;){const e=u.shift();e&&O(e)}}function T(e){g||(g=!0,o.abort(),p.releaseLock(),e instanceof TypeError&&("Failed to fetch"===e.message||"fetch failed"===e.message)?d(new y):d(e))}E().catch(T)}))}({uploadId:n.uploadId,key:n.key,pathname:e,stream:a,headers:r,options:s});return await S({uploadId:n.uploadId,key:n.key,pathname:e,parts:o,headers:r,options:s})}t.getTokenFromOptionsOrEnv=a,t.BlobError=i,t.getDownloadUrl=function(e){const t=new URL(e);return t.searchParams.set("download","1"),t.toString()},t.BlobAccessError=p,t.BlobStoreNotFoundError=m,t.BlobStoreSuspendedError=h,t.BlobUnknownError=w,t.BlobNotFoundError=g,t.BlobServiceNotAvailable=y,t.BlobServiceRateLimited=b,t.BlobRequestAbortedError=f,t.requestApi=A,t.createCompleteMultipartUploadMethod=function({allowedOptions:e,getToken:t,extraChecks:r}){return async(s,a,n)=>{const o=await q({pathname:s,options:n,extraChecks:r,getToken:t}),i=T(e,o);return S({uploadId:o.uploadId,key:o.key,pathname:s,headers:i,options:o,parts:a})}},t.createCreateMultipartUploadMethod=function({allowedOptions:e,getToken:t,extraChecks:r}){return async(s,a)=>{const n=await q({pathname:s,options:a,extraChecks:r,getToken:t}),o=T(e,n),i=await N(s,o,n);return{key:i.key,uploadId:i.uploadId}}},t.createUploadPartMethod=function({allowedOptions:e,getToken:t,extraChecks:r}){return async(s,a,n)=>{const o=await q({pathname:s,options:n,extraChecks:r,getToken:t}),i=T(e,o);return{etag:(await M({uploadId:o.uploadId,key:o.key,pathname:s,part:{blob:a,partNumber:o.partNumber},headers:i,options:o})).etag,partNumber:o.partNumber}}},t.createPutMethod=function({allowedOptions:e,getToken:t,extraChecks:r}){return async function(s,a,n){const o=s.endsWith("/");if(!a&&!o)throw new i("body is required");if(a&&n&&o)throw new i("body is not allowed for creating empty folders");const d=o?void 0:a,u=await q({pathname:s,options:o?a:n,extraChecks:r,getToken:t}),c=T(e,u);if(!0===u.multipart&&d)return k(s,d,c,u);const l=await A(`/${s}`,{method:"PUT",body:d,headers:c,duplex:"half",signal:u.abortSignal},u);return{url:l.url,downloadUrl:l.downloadUrl,pathname:l.pathname,contentType:l.contentType,contentDisposition:l.contentDisposition}}},t.createCreateMultipartUploaderMethod=function({allowedOptions:e,getToken:t,extraChecks:r}){return async(s,a)=>{const n=await q({pathname:s,options:a,extraChecks:r,getToken:t}),o=T(e,n),i=await N(s,o,n);return{key:i.key,uploadId:i.uploadId,uploadPart:async(e,t)=>({etag:(await M({uploadId:i.uploadId,key:i.key,pathname:s,part:{partNumber:e,blob:t},headers:o,options:n})).etag,partNumber:e}),complete:async e=>S({uploadId:i.uploadId,key:i.key,pathname:s,parts:e,headers:o,options:n})}}}},311:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(9847);function a(e){return{url:e.url,downloadUrl:e.downloadUrl,pathname:e.pathname,size:e.size,uploadedAt:new Date(e.uploadedAt)}}var n=s.createPutMethod.call(void 0,{allowedOptions:["cacheControlMaxAge","addRandomSuffix","contentType"]}),o=s.createCreateMultipartUploadMethod.call(void 0,{allowedOptions:["cacheControlMaxAge","addRandomSuffix","contentType"]}),i=s.createCreateMultipartUploaderMethod.call(void 0,{allowedOptions:["cacheControlMaxAge","addRandomSuffix","contentType"]}),d=s.createUploadPartMethod.call(void 0,{allowedOptions:["cacheControlMaxAge","addRandomSuffix","contentType"]}),u=s.createCompleteMultipartUploadMethod.call(void 0,{allowedOptions:["cacheControlMaxAge","addRandomSuffix","contentType"]});t.BlobAccessError=s.BlobAccessError,t.BlobError=s.BlobError,t.BlobNotFoundError=s.BlobNotFoundError,t.BlobRequestAbortedError=s.BlobRequestAbortedError,t.BlobServiceNotAvailable=s.BlobServiceNotAvailable,t.BlobServiceRateLimited=s.BlobServiceRateLimited,t.BlobStoreNotFoundError=s.BlobStoreNotFoundError,t.BlobStoreSuspendedError=s.BlobStoreSuspendedError,t.BlobUnknownError=s.BlobUnknownError,t.completeMultipartUpload=u,t.copy=async function(e,t,r){if(!r)throw new(0,s.BlobError)("missing options, see usage");if("public"!==r.access)throw new(0,s.BlobError)('access must be "public"');const a={};void 0!==r.addRandomSuffix&&(a["x-add-random-suffix"]=r.addRandomSuffix?"1":"0"),r.contentType&&(a["x-content-type"]=r.contentType),void 0!==r.cacheControlMaxAge&&(a["x-cache-control-max-age"]=r.cacheControlMaxAge.toString());const n=await s.requestApi.call(void 0,`/${t}?fromUrl=${e}`,{method:"PUT",headers:a,signal:r.abortSignal},r);return{url:n.url,downloadUrl:n.downloadUrl,pathname:n.pathname,contentType:n.contentType,contentDisposition:n.contentDisposition}},t.createMultipartUpload=o,t.createMultipartUploader=i,t.del=async function(e,t){await s.requestApi.call(void 0,"/delete",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({urls:Array.isArray(e)?e:[e]}),signal:null==t?void 0:t.abortSignal},t)},t.getDownloadUrl=s.getDownloadUrl,t.head=async function(e,t){const r=new URLSearchParams({url:e}),a=await s.requestApi.call(void 0,`?${r.toString()}`,{method:"GET",signal:null==t?void 0:t.abortSignal},t);return{url:a.url,downloadUrl:a.downloadUrl,pathname:a.pathname,size:a.size,contentType:a.contentType,contentDisposition:a.contentDisposition,cacheControl:a.cacheControl,uploadedAt:new Date(a.uploadedAt)}},t.list=async function(e){var t;const r=new URLSearchParams;(null==e?void 0:e.limit)&&r.set("limit",e.limit.toString()),(null==e?void 0:e.prefix)&&r.set("prefix",e.prefix),(null==e?void 0:e.cursor)&&r.set("cursor",e.cursor),(null==e?void 0:e.mode)&&r.set("mode",e.mode);const n=await s.requestApi.call(void 0,`?${r.toString()}`,{method:"GET",signal:null==e?void 0:e.abortSignal},e);return"folded"===(null==e?void 0:e.mode)?{folders:null!=(t=n.folders)?t:[],cursor:n.cursor,hasMore:n.hasMore,blobs:n.blobs.map(a)}:{cursor:n.cursor,hasMore:n.hasMore,blobs:n.blobs.map(a)}},t.put=n,t.uploadPart=d}},t={};!function r(s){var a=t[s];if(void 0!==a)return a.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,r),n.exports}(5237)})();